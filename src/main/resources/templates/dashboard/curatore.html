<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Curatore</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <style>
        table {
            border-collapse: collapse;
            margin-top: 20px;
            width: 100%;
            max-width: 1200px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        th { background: #f2f2f2; }
        button {
            margin: 4px;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        .commento-input { width: 100%; min-width: 150px; }
        img.thumb { max-height: 40px; border-radius: 4px; }
        ul { margin: 0; padding-left: 18px; }
    </style>
</head>
<body>
<h1 th:text="'Benvenuto ' + (${utente?.nome ?: 'Utente'}) + ', il tuo ruolo √® ' + (${utente?.ruolo ?: 'Curatore'}) + '.'">
    Benvenuto, il tuo ruolo √® Curatore.
</h1>

<h2>Dashboard Curatore</h2>

<!-- bottone eliminazione profilo -->
<button id="btnDeleteProfile" class="btn btn-danger btn-lg">
    üóëÔ∏è Elimina profilo
</button>
<!-- Bottone Visualizza Social -->
<div class="actions-container">
    <button id="btnSocialFeed" type="button" class="btn-primary">
        üì¢ Visualizza Social Network
    </button>
</div>
<div><button id="btnApriMappa" class="btn-primary">üåç Visualizza mappa</button></div>


<!-- ====== PRODOTTI ====== -->
<h3>Prodotti in attesa di approvazione</h3>
<table>
    <thead>
    <tr>
        <th>Nome</th><th>Creatore</th><th>Descrizione</th><th>Quantit√†</th><th>Prezzo</th><th>Indirizzo</th>
        <th>Certificati</th><th>Foto</th><th>Accetta</th><th>Rifiuta</th><th>Commento</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="prodotto : ${prodotti}">
        <td th:text="${prodotto.nome}"></td>
        <td th:text="${prodotto.creatoDa}"></td>
        <td th:text="${prodotto.descrizione}"></td>
        <td th:text="${prodotto.quantita}"></td>
        <td th:text="${prodotto.prezzo}"></td>
        <td th:text="${prodotto.indirizzo}"></td>

        <!-- Certificati -->
        <td>
            <span th:if="${#strings.isEmpty(prodotto.certificatiCsv)}">-</span>
            <span th:each="cert : ${#strings.arraySplit(prodotto.certificatiCsv, ',')}" th:if="${!#strings.isEmpty(prodotto.certificatiCsv)}">
                <a th:href="@{'/file/certificati/' + ${cert}}" target="_blank" th:text="${cert}"></a><br/>
            </span>
        </td>

        <!-- Foto -->
        <td>
            <span th:if="${#strings.isEmpty(prodotto.fotoCsv)}">-</span>
            <span th:each="foto : ${#strings.arraySplit(prodotto.fotoCsv, ',')}" th:if="${!#strings.isEmpty(prodotto.fotoCsv)}">
                <a th:href="@{'/file/foto/' + ${foto}}" target="_blank">
                    <img th:src="@{'/file/foto/' + ${foto}}" alt="Foto" class="thumb"/>
                </a>
            </span>
        </td>

        <!-- Azioni -->
        <td>
            <form th:action="@{/curatore/approvaProdotto}" method="post">
                <input type="hidden" name="nome" th:value="${prodotto.nome}"/>
                <input type="hidden" name="creatore" th:value="${prodotto.creatoDa}"/>
                <button type="button" class="approve-btn" th:attr="data-nome=${prodotto.nome}">Accetta</button>
            </form>
        </td>
        <td>
            <form th:action="@{/curatore/rifiutaProdotto}" method="post"
                  th:id="'form-rifiuta-prod-' + ${prodotto.nome} + '-' + ${prodotto.creatoDa}">
                <input type="hidden" name="nome" th:value="${prodotto.nome}"/>
                <input type="hidden" name="creatore" th:value="${prodotto.creatoDa}"/>
                <button type="button" class="reject-btn" th:attr="data-nome=${prodotto.nome}">Rifiuta</button>
            </form>
        </td>
        <td>
            <input type="text" name="commento" class="commento-input"
                   placeholder="Inserisci commento"
                   th:form="'form-rifiuta-prod-' + ${prodotto.nome} + '-' + ${prodotto.creatoDa}"/>
        </td>
    </tr>
    </tbody>
</table>


<!-- ====== PACCHETTI ====== -->
<h3>Pacchetti in attesa di approvazione</h3>
<table>
    <thead>
    <tr>
        <th>Nome</th><th>Creatore</th><th>Descrizione</th><th>Prezzo</th><th>Indirizzo</th>
        <th>Certificati</th><th>Foto</th><th>Prodotti Inclusi</th>
        <th>Accetta</th><th>Rifiuta</th><th>Commento</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="pacchetto : ${pacchetti}">
        <td th:text="${pacchetto.nome}"></td>
        <td th:text="${pacchetto.creatoDa}"></td>
        <td th:text="${pacchetto.descrizione}"></td>
        <td th:text="${pacchetto.prezzo}"></td>
        <td th:text="${pacchetto.indirizzo}"></td>

        <!-- Certificati -->
        <td>
            <span th:if="${#strings.isEmpty(pacchetto.certificatiCsv)}">-</span>
            <span th:each="cert : ${#strings.arraySplit(pacchetto.certificatiCsv, ',')}" th:if="${!#strings.isEmpty(pacchetto.certificatiCsv)}">
                <a th:href="@{'/file/certificati/' + ${cert}}" target="_blank" th:text="${cert}"></a><br/>
            </span>
        </td>

        <!-- Foto -->
        <td>
            <span th:if="${#strings.isEmpty(pacchetto.fotoCsv)}">-</span>
            <span th:each="foto : ${#strings.arraySplit(pacchetto.fotoCsv, ',')}" th:if="${!#strings.isEmpty(pacchetto.fotoCsv)}">
                <a th:href="@{'/file/foto/' + ${foto}}" target="_blank">
                    <img th:src="@{'/file/foto/' + ${foto}}" alt="Foto" class="thumb"/>
                </a>
            </span>
        </td>

        <!-- Prodotti inclusi -->
        <td>
            <ul>
                <li th:each="nomeProd : ${pacchetto.prodottiNomi}" th:text="${nomeProd}"></li>
            </ul>
        </td>

        <!-- Azioni -->
        <td>
            <form th:action="@{/curatore/approvaPacchetto}" method="post">
                <input type="hidden" name="nome" th:value="${pacchetto.nome}"/>
                <input type="hidden" name="creatore" th:value="${pacchetto.creatoDa}"/>
                <button type="button" class="approve-btn" th:attr="data-nome=${pacchetto.nome}">Accetta</button>
            </form>
        </td>
        <td>
            <form th:action="@{/curatore/rifiutaPacchetto}" method="post"
                  th:id="'form-rifiuta-pac-' + ${pacchetto.nome} + '-' + ${pacchetto.creatoDa}">
                <input type="hidden" name="nome" th:value="${pacchetto.nome}"/>
                <input type="hidden" name="creatore" th:value="${pacchetto.creatoDa}"/>
                <button type="button" class="reject-btn" th:attr="data-nome=${pacchetto.nome}">Rifiuta</button>
            </form>
        </td>
        <td>
            <input type="text" name="commento" class="commento-input"
                   placeholder="Inserisci commento"
                   th:form="'form-rifiuta-pac-' + ${pacchetto.nome} + '-' + ${pacchetto.creatoDa}"/>
        </td>
    </tr>
    </tbody>
</table>


<!-- ====== TRASFORMATI ====== -->
<h3>Prodotti Trasformati in attesa di approvazione</h3>
<table>
    <thead>
    <tr>
        <th>Nome</th><th>Creatore</th><th>Descrizione</th><th>Indirizzo</th>
        <th>Certificati</th><th>Foto</th><th>Fasi Produzione</th>
        <th>Accetta</th><th>Rifiuta</th><th>Commento</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="trasf : ${trasformati}">
        <td th:text="${trasf.nome}"></td>
        <td th:text="${trasf.creatoDa}"></td>
        <td th:text="${trasf.descrizione}"></td>
        <td th:text="${trasf.indirizzo}"></td>

        <!-- Certificati -->
        <td>
            <span th:if="${#strings.isEmpty(trasf.certificatiCsv)}">-</span>
            <span th:each="cert : ${#strings.arraySplit(trasf.certificatiCsv, ',')}" th:if="${!#strings.isEmpty(trasf.certificatiCsv)}">
                <a th:href="@{'/file/certificati/' + ${cert}}" target="_blank" th:text="${cert}"></a><br/>
            </span>
        </td>

        <!-- Foto -->
        <td>
            <span th:if="${#strings.isEmpty(trasf.fotoCsv)}">-</span>
            <span th:each="foto : ${#strings.arraySplit(trasf.fotoCsv, ',')}" th:if="${!#strings.isEmpty(trasf.fotoCsv)}">
                <a th:href="@{'/file/foto/' + ${foto}}" target="_blank">
                    <img th:src="@{'/file/foto/' + ${foto}}" alt="Foto" class="thumb"/>
                </a>
            </span>
        </td>

        <!-- Fasi Produzione -->
        <td>
            <ul>
                <li th:each="fase : ${trasf.fasiProduzione}">
                    <span th:text="${fase.descrizioneFase}"></span> -
                    <span th:text="${fase.produttoreUsername}"></span> -
                    <span th:text="${fase.prodottoOrigineId}"></span>
                </li>
            </ul>
        </td>

        <!-- Azioni -->
        <td>
            <form th:action="@{/curatore/approvaTrasformato}" method="post">
                <input type="hidden" name="nome" th:value="${trasf.nome}"/>
                <input type="hidden" name="creatore" th:value="${trasf.creatoDa}"/>
                <button type="button" class="approve-btn" th:attr="data-nome=${trasf.nome}">Accetta</button>
            </form>
        </td>
        <td>
            <form th:action="@{/curatore/rifiutaTrasformato}" method="post"
                  th:id="'form-rifiuta-trasf-' + ${trasf.nome} + '-' + ${trasf.creatoDa}">
                <input type="hidden" name="nome" th:value="${trasf.nome}"/>
                <input type="hidden" name="creatore" th:value="${trasf.creatoDa}"/>
                <button type="button" class="reject-btn" th:attr="data-nome=${trasf.nome}">Rifiuta</button>
            </form>
        </td>
        <td>
            <input type="text" name="commento" class="commento-input"
                   placeholder="Inserisci commento"
                   th:form="'form-rifiuta-trasf-' + ${trasf.nome} + '-' + ${trasf.creatoDa}"/>
        </td>
    </tr>
    </tbody>
</table>


<!-- Modali conferma approvazione/rifiuto -->
<div id="approveModal" class="modal">
    <div class="modal-content">
        <p id="approveMessage"></p>
        <button onclick="closeApproveModal()">OK</button>
    </div>
</div>
<div id="rejectModal" class="modal">
    <div class="modal-content">
        <p id="rejectMessage"></p>
        <button onclick="closeRejectModal()">OK</button>
    </div>
</div>

<!-- Modali comuni -->
<div th:replace="fragments/profile-delete-modal :: profile-delete-modal"></div>
<div th:replace="fragments/profile-delete-notification :: profile-delete-notification"></div>
<div th:replace="fragments/modals :: social-modals('/curatore/dashboard')"></div>
<div th:replace="fragments/modals :: social-feed-modal"></div>
<div th:replace="fragments/modals :: social-not-available-modal"></div>

<!-- Modale mappa -->
<div id="mapModal" class="modal">
    <div class="modal-content large">
        <h2>üó∫Ô∏è Mappa Indirizzi</h2>
        <div id="map" style="height: 400px; width: 100%; border-radius: 8px;"></div>
        <div class="modal-actions">
            <button class="btn-close-modal btn-secondary" data-target="mapModal">Chiudi</button>
        </div>
    </div>
</div>

<p><a th:href="@{/}">‚¨Ö Torna alla Home</a></p>

<!-- Script gestione modali locali -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".approve-btn").forEach(btn => {
            btn.addEventListener("click", function () {
                const nome = this.getAttribute("data-nome");
                document.getElementById("approveMessage").textContent = nome + " approvato!";
                document.getElementById("approveModal").style.display = "flex";
                window.formToSubmit = this.closest("form");
            });
        });
        document.querySelectorAll(".reject-btn").forEach(btn => {
            btn.addEventListener("click", function () {
                const nome = this.getAttribute("data-nome");
                document.getElementById("rejectMessage").textContent = nome + " rifiutato!";
                document.getElementById("rejectModal").style.display = "flex";
                window.formToSubmit = this.closest("form");
            });
        });
    });
    function closeApproveModal() {
        document.getElementById("approveModal").style.display = "none";
        if (window.formToSubmit) { window.formToSubmit.submit(); window.formToSubmit = null; }
    }
    function closeRejectModal() {
        document.getElementById("rejectModal").style.display = "none";
        if (window.formToSubmit) { window.formToSubmit.submit(); window.formToSubmit = null; }
    }
</script>

<script type="module" src="/js/pages/curatore.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</body>
</html>
