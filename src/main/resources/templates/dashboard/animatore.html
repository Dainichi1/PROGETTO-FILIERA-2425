<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <title>Dashboard Animatore</title>
    <meta charset="UTF-8"/>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
</head>
<body>
<h1 th:text="'Benvenuto ' + (${utente?.nome ?: 'Utente'}) +
              ', il tuo ruolo √® ' + (${utente?.ruolo ?: 'Animatore'}) + '.'">
    Benvenuto, il tuo ruolo √® Animatore.
</h1>

<!-- ================== BOTTONI PRINCIPALI ================== -->
<div style="display: flex; gap: 20px; margin: 20px 0;">
    <button type="button" class="btn-primary" onclick="crudUtils.openSocialFeed()">
        üì¢ Visualizza Social Network
    </button>
</div>

<!-- ================== SEZIONE PUBBLICATI ================== -->
<div th:replace="fragments/animatore-table.html :: pubblicati-section(${visite}, ${fiere})"></div>

<!-- ================== MODALI CREAZIONE EVENTI ================== -->
<div th:replace="fragments/animatore-modals :: animatore-create-modals('/animatore/dashboard')"></div>

<!-- ================== MODALI SOCIAL (COMUNI) ================== -->
<div th:replace="fragments/modals :: social-modal"></div>
<div th:replace="fragments/modals :: social-feed-modal"></div>
<div th:replace="fragments/modals :: social-post-modals('/animatore/dashboard')"></div>

<hr class="section-separator"/>

<!-- ================== BOTTONI APERTURA FORM ================== -->
<button type="button" class="btn-primary" onclick="visitaCrud.toggleForm()">
    ‚ûï Pubblica Visita ad Invito
</button>
<button type="button" class="btn-primary" onclick="fieraCrud.toggleForm()">
    ‚ûï Pubblica Fiera
</button>

<!-- ================== FORM CREAZIONE VISITA ================== -->
<div id="visitaFormContainer" class="form-container"
     th:style="${showForm} ? 'display:block;' : 'display:none;'">

    <h3 id="formTitle">Nuova Visita ad Invito</h3>
    <form id="visitaForm" th:action="@{/animatore/crea-visita}" th:object="${visitaDto}"
          method="post" novalidate>
        <input type="hidden" th:field="*{id}" id="visitaId"/>
        <input type="hidden" th:field="*{tipo}" id="eventoTipo" value="VISITA"/>
        <div th:replace="fragments/animatore-fields :: visita-fields('visitaDto')"></div>
        <div id="createButtons" class="form-actions">
            <button type="button" class="btn-primary"
                    onclick="modalUtils.openModal('createConfirmModalVisita')">‚úÖ Pubblica</button>
            <button type="button" class="btn-secondary"
                    onclick="visitaCrud.toggleForm()">‚ùå Annulla</button>
        </div>
    </form>
</div>

<!-- ================== FORM CREAZIONE FIERA ================== -->
<div id="fieraFormContainer" class="form-container" style="display:none;">
    <h3 id="formTitleFiera">Nuova Fiera</h3>
    <form id="fieraForm" th:action="@{/animatore/crea-fiera}" th:object="${fieraDto}"
          method="post" novalidate>
        <input type="hidden" th:field="*{id}" id="fieraId"/>
        <input type="hidden" th:field="*{tipo}" id="eventoTipoFiera" value="FIERA"/>
        <div th:replace="fragments/animatore-fields :: fiera-fields('fieraDto')"></div>
        <div id="createButtonsFiera" class="form-actions">
            <button type="button" class="btn-primary"
                    onclick="modalUtils.openModal('createConfirmModalFiera')">‚úÖ Pubblica</button>
            <button type="button" class="btn-secondary"
                    onclick="fieraCrud.toggleForm()">‚ùå Annulla</button>
        </div>
    </form>
</div>

<!-- ================== LINK HOME ================== -->
<p><a th:href="@{/}">‚¨Ö Torna alla Home</a></p>

<!-- ================== SCRIPT ================== -->
<script src="/js/utils/form-utils.js" defer></script>
<script src="/js/utils/modal-utils.js" defer></script>
<script src="/js/utils/csrf-utils.js" defer></script>
<script src="/js/utils/crud-utils.js" defer></script>
<script src="/js/utils/crud-utils-animatore.js" defer></script>
<script src="/js/pages/animatore.js" defer></script>

<!-- ================== FIX SOCIAL POST ================== -->
<script defer>
    document.addEventListener("DOMContentLoaded", () => {
        const confirmBtn = document.getElementById("btnConfirmSocialPost");
        if (confirmBtn) {
            confirmBtn.onclick = () => {
                if (window.currentCrud && typeof window.currentCrud.submitSocialPost === "function") {
                    console.log("[DEBUG] Conferma social ‚Üí submitSocialPost()");
                    window.currentCrud.submitSocialPost();
                } else {
                    console.error("[ERRORE] Nessuna istanza CRUD attiva trovata!");
                }
            };
        }
    });
</script>

</body>
</html>
