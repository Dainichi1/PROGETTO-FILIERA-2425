<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <title>Dashboard Produttore</title>
    <meta charset="UTF-8"/>
    <style>
        .form-container { display:none; margin-top:20px; padding:15px; border:1px solid #ccc; border-radius:6px; background:#f9f9f9; max-width:500px; }
        .form-container label { display:block; margin-top:10px; font-weight:bold; }
        .form-container input, .form-container textarea { width:100%; padding:6px; margin-top:5px; }
        .form-container input.error, .form-container textarea.error { border:2px solid red; }
        .error-message { color:red; font-size:0.9rem; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
        .modal-content { background:white; padding:20px; border-radius:8px; text-align:center; max-width:400px; }
        .modal-content button { margin:10px; padding:8px 16px; }
        .section-separator { margin:40px 0; border:none; border-top:2px dashed #bbb; }
    </style>
</head>
<body>
<h1 th:text="'Benvenuto ' + ${utente != null ? utente.nome : 'Utente'} + ', il tuo ruolo è ' + (${utente != null ? utente.ruolo : 'Produttore'}) + '.'">
    Benvenuto, il tuo ruolo è Produttore.
</h1>

<h2>Dashboard Produttore</h2>
<h2>I tuoi Prodotti</h2>

<table border="1" style="border-collapse: collapse; width: 100%; margin-top: 20px;">
    <thead>
    <tr style="background-color: #f0f0f0; text-align: center;">
        <th>Nome Prodotto</th>
        <th>Descrizione</th>
        <th>Quantità</th>
        <th>Prezzo</th>
        <th>Indirizzo</th>
        <th>Certificati</th>
        <th>Foto</th>
        <th>Stato</th>
        <th>Commento</th>
        <th>Elimina</th>
        <th>Modifica</th>
        <th>Social</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="prodotto : ${prodotti}" th:attr="data-id=${prodotto.id}">
        <td th:text="${prodotto.nome}">Nome</td>
        <td th:text="${prodotto.descrizione}">Descrizione</td>
        <td th:text="${prodotto.quantita}">Quantità</td>
        <td th:text="${prodotto.prezzo}">Prezzo</td>
        <td th:text="${prodotto.indirizzo}">Indirizzo</td>

        <!-- Certificati -->
        <td>
            <a th:each="cert : ${prodotto.certificati}"
               th:href="@{'/file/certificati/' + ${cert}}"
               target="_blank"
               th:text="${cert}">Certificato</a>
        </td>

        <!-- Foto -->
        <td>
            <a th:each="foto : ${prodotto.foto}"
               th:href="@{'/file/foto/' + ${foto}}"
               target="_blank"
               th:text="${foto}">Foto</a>
        </td>

        <!-- Stato approvazione -->
        <td th:text="${prodotto.stato}">In attesa</td>

        <!-- Commento del Curatore -->
        <td th:text="${prodotto.commento}">Commento</td>

        <!-- Bottone elimina -->
        <td>
            <button type="button"
                    th:attr="data-id=${prodotto.id}, data-stato=${prodotto.stato}, data-nome=${prodotto.nome}"
                    onclick="handleDeleteClick(this)">
                Elimina
            </button>
        </td>

        <!-- Colonne segnaposto -->
        <td>-</td>
        <td>-</td>
    </tr>
    </tbody>
</table>

<!-- Modale errore eliminazione approvati -->
<div id="deleteErrorModal" class="modal">
    <div class="modal-content">
        <p>Puoi eliminare solo prodotti in attesa o rifiutati.</p>
        <button onclick="closeModal('deleteErrorModal')">OK</button>
    </div>
</div>

<!-- Modale conferma eliminazione -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
        <p id="deleteConfirmMessage"></p>
        <button onclick="confirmDelete()">Sì</button>
        <button onclick="closeModal('deleteConfirmModal')">No</button>
    </div>
</div>

<!-- Modale successo eliminazione -->
<div id="deleteSuccessModal" class="modal">
    <div class="modal-content">
        <p id="deleteSuccessMessage"></p>
        <button onclick="closeModal('deleteSuccessModal')">OK</button>
    </div>
</div>

<!-- Modale errore generico eliminazione -->
<div id="deleteGenericErrorModal" class="modal">
    <div class="modal-content">
        <p id="deleteGenericErrorMessage"></p>
        <button onclick="closeModal('deleteGenericErrorModal')">OK</button>
    </div>
</div>

<!-- Separatore tra tabella e form -->
<hr class="section-separator"/>

<button type="button" onclick="toggleForm()">Crea Prodotto</button>

<!-- FORM CREAZIONE -->
<div id="prodottoForm" class="form-container"
     th:style="${showForm} ? 'display:block;' : 'display:none;'">
    <h3>Nuovo Prodotto</h3>
    <form id="createProductForm"
          th:action="@{/produttore/crea}"
          th:object="${prodottoDto}"
          method="post"
          enctype="multipart/form-data">

        <label for="nome">Nome prodotto:</label>
        <input type="text" th:field="*{nome}" id="nome" th:classappend="${#fields.hasErrors('nome')} ? 'error'"/>
        <span class="error-message" th:errors="*{nome}"></span>

        <label for="descrizione">Descrizione:</label>
        <textarea th:field="*{descrizione}" id="descrizione" th:classappend="${#fields.hasErrors('descrizione')} ? 'error'"></textarea>
        <span class="error-message" th:errors="*{descrizione}"></span>

        <label for="quantita">Quantità:</label>
        <input type="number" th:field="*{quantita}" id="quantita" th:classappend="${#fields.hasErrors('quantita')} ? 'error'"/>
        <span class="error-message" th:errors="*{quantita}"></span>

        <label for="prezzo">Prezzo:</label>
        <input type="number" step="0.01" th:field="*{prezzo}" id="prezzo" th:classappend="${#fields.hasErrors('prezzo')} ? 'error'"/>
        <span class="error-message" th:errors="*{prezzo}"></span>

        <label for="indirizzo">Indirizzo:</label>
        <input type="text" th:field="*{indirizzo}" id="indirizzo" th:classappend="${#fields.hasErrors('indirizzo')} ? 'error'"/>
        <span class="error-message" th:errors="*{indirizzo}"></span>

        <label for="certificati">Seleziona certificati:</label>
        <input type="file" th:field="*{certificati}" id="certificati" multiple th:classappend="${#fields.hasErrors('certificati')} ? 'error'"/>
        <span class="error-message" th:errors="*{certificati}"></span>

        <label for="foto">Seleziona foto:</label>
        <input type="file" th:field="*{foto}" id="foto" multiple th:classappend="${#fields.hasErrors('foto')} ? 'error'"/>
        <span class="error-message" th:errors="*{foto}"></span>

        <button type="button" onclick="openConfirmModal()">Invia Prodotto</button>
        <button type="button" onclick="toggleForm()">Chiudi Form</button>
    </form>
</div>

<!-- Modale conferma invio -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <p>Inviare il prodotto al Curatore per approvazione?</p>
        <button onclick="submitForm()">Sì</button>
        <button onclick="closeModal('confirmModal')">No</button>
    </div>
</div>

<!-- Modale successo creazione -->
<div id="successModal" class="modal" th:if="${successMessage}">
    <div class="modal-content">
        <p th:text="${successMessage}">Prodotto inviato al Curatore!</p>
        <button onclick="window.location.href='/dashboard'">OK</button>
    </div>
</div>

<script>
    function toggleForm() {
        const form = document.getElementById("prodottoForm");
        form.style.display = (form.style.display === "none") ? "block" : "none";
    }

    function openConfirmModal() {
        document.getElementById("confirmModal").style.display = "flex";
    }

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }

    function submitForm() {
        closeModal("confirmModal");
        document.getElementById("createProductForm").submit();
    }

    window.addEventListener("load", () => {
        const successModal = document.getElementById("successModal");
        if (successModal) {
            successModal.style.display = "flex";
        }
    });

    // ======================
    // Gestione eliminazione
    // ======================
    let selectedProductId = null;
    let selectedProductName = null;

    function handleDeleteClick(button) {
        const stato = button.getAttribute("data-stato");
        const nome = button.getAttribute("data-nome");
        const id = button.getAttribute("data-id");

        if (stato === "APPROVATO") {
            document.getElementById("deleteErrorModal").style.display = "flex";
        } else {
            selectedProductId = id;
            selectedProductName = nome;
            document.getElementById("deleteConfirmMessage").textContent =
                `Vuoi davvero eliminare il prodotto "${nome}"?`;
            document.getElementById("deleteConfirmModal").style.display = "flex";
        }
    }

    function confirmDelete() {
        fetch(`/produttore/elimina/${selectedProductId}`, {
            method: "DELETE"
        })
            .then(response => {
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    return response.json().then(err => {
                        throw new Error(err.message || "Errore sconosciuto");
                    });
                } else {
                    return response.text().then(msg => {
                        if (response.ok) {
                            // Rimuovi riga dalla tabella
                            const row = document.querySelector(`tr[data-id='${selectedProductId}']`);
                            if (row) row.remove();

                            // Mostra modale successo
                            closeModal("deleteConfirmModal");
                            document.getElementById("deleteSuccessMessage").textContent = msg;
                            document.getElementById("deleteSuccessModal").style.display = "flex";
                        } else {
                            throw new Error(msg || "Errore generico");
                        }
                    });
                }
            })
            .catch(err => {
                closeModal("deleteConfirmModal");
                document.getElementById("deleteGenericErrorMessage").textContent = err.message;
                document.getElementById("deleteGenericErrorModal").style.display = "flex";
            });
    }


</script>

<p><a th:href="@{/}">Torna alla Home</a></p>
</body>
</html>
