<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<!-- ================== MODALI ELIMINAZIONE ================== -->
<div th:fragment="delete-modals(itemName)">
    <div id="deleteErrorModal" class="modal">
        <div class="modal-content">
            <p>Puoi eliminare solo [[${itemName}]] in attesa o rifiutati.</p>
            <button type="button" onclick="modalUtils.closeModal('deleteErrorModal')">OK</button>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <p id="deleteConfirmMessage"></p>
            <button type="button" onclick="crudUtils.confirmDelete()">SÃ¬</button>
            <button type="button" onclick="modalUtils.closeModal('deleteConfirmModal')">No</button>
        </div>
    </div>

    <div id="deleteSuccessModal" class="modal">
        <div class="modal-content">
            <p id="deleteSuccessMessage"></p>
            <button type="button" onclick="modalUtils.closeModal('deleteSuccessModal')">OK</button>
        </div>
    </div>

    <div id="deleteGenericErrorModal" class="modal">
        <div class="modal-content">
            <p id="deleteGenericErrorMessage"></p>
            <button type="button" onclick="modalUtils.closeModal('deleteGenericErrorModal')">OK</button>
        </div>
    </div>
</div>

<!-- ================== MODALI MODIFICA ================== -->
<div th:fragment="edit-error-modal(itemName)">
    <div id="editErrorModal" class="modal">
        <div class="modal-content">
            <p>Puoi modificare solo [[${itemName}]] rifiutati.</p>
            <button type="button" onclick="modalUtils.closeModal('editErrorModal')">OK</button>
        </div>
    </div>
</div>

<!-- ================== CREAZIONE/UPDATE Prod/Dist/Trasf ================== -->
<div th:fragment="create-update-modals(entityName, redirectPath)">
    <div id="createConfirmModal" class="modal">
        <div class="modal-content">
            <p th:text="|Inviare ${entityName} al Curatore per approvazione?|"></p>
            <button type="button" onclick="crudUtils.submitForm()">SÃ¬</button>
            <button type="button" onclick="modalUtils.closeModal('createConfirmModal')">No</button>
        </div>
    </div>

    <div id="createSuccessModal" class="modal">
        <div class="modal-content">
            <p id="createSuccessMessage"></p>
            <button type="button" class="redirect-btn" th:attr="data-redirect=${redirectPath}">OK</button>
        </div>
    </div>

    <div id="updateConfirmModal" class="modal">
        <div class="modal-content">
            <p th:text="|Sei sicuro di voler aggiornare e rinviare ${entityName} al Curatore?|"></p>
            <button type="button" onclick="crudUtils.submitForm()">SÃ¬</button>
            <button type="button" onclick="modalUtils.closeModal('updateConfirmModal')">No</button>
        </div>
    </div>

    <div id="updateSuccessModal" class="modal">
        <div class="modal-content">
            <p id="updateSuccessMessage"></p>
            <button type="button" class="redirect-btn" th:attr="data-redirect=${redirectPath}">OK</button>
        </div>
    </div>
</div>

<!-- ================== MODALI SPECIFICI FIERE ================== -->
<div th:fragment="fiera-create-modals(redirectPath)">
    <div id="createConfirmModalFiera" class="modal">
        <div class="modal-content">
            <p>Vuoi pubblicare la fiera?</p>
            <button type="button" onclick="fieraCrud.submitForm()">SÃ¬</button>
            <button type="button" onclick="modalUtils.closeModal('createConfirmModalFiera')">No</button>
        </div>
    </div>

    <div id="createSuccessModalFiera" class="modal">
        <div class="modal-content">
            <p>âœ… Fiera pubblicata con successo!</p>
            <button type="button" class="redirect-btn" th:attr="data-redirect=${redirectPath}">OK</button>
        </div>
    </div>
</div>

<!-- ================== MODALI SOCIAL ================== -->
<div th:fragment="social-modal">
    <div id="socialNotAvailableModal" class="modal">
        <div class="modal-content">
            <p id="socialNotAvailableMessage">L'opzione Ã¨ disponibile solo per prodotti approvati.</p>
            <button type="button" onclick="modalUtils.closeModal('socialNotAvailableModal')">OK</button>
        </div>
    </div>
</div>

<div th:fragment="social-post-modals(redirectPath)">
    <div id="socialPostModal" class="modal">
        <div class="modal-content">
            <h3>Pubblica sui Social</h3>
            <form id="socialPostForm" onsubmit="return false;">
                <label for="postTitle">Titolo* (max 100):</label>
                <input type="text" id="postTitle" maxlength="100" required />
                <span class="error-message"></span>

                <label for="postText">Testo* (max 1000):</label>
                <textarea id="postText" maxlength="1000" required></textarea>
                <span class="error-message"></span>

                <div class="modal-buttons">
                    <button id="btnOkSocialPost" type="button">OK</button>
                    <button type="button" onclick="modalUtils.closeModal('socialPostModal')">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <div id="socialConfirmModal" class="modal">
        <div class="modal-content">
            <p>Sei sicuro di voler pubblicare l'annuncio sui social?</p>
            <button id="btnConfirmSocialPost" type="button">SÃ¬</button>
            <button type="button" onclick="modalUtils.closeModal('socialConfirmModal')">No</button>
        </div>
    </div>

    <div id="socialSuccessModal" class="modal">
        <div class="modal-content">
            <p>âœ… Annuncio pubblicato con successo!</p>
            <button type="button" class="redirect-btn" th:attr="data-redirect=${redirectPath}">OK</button>
        </div>
    </div>
</div>

<div th:fragment="social-feed-modal">
    <div id="socialFeedModal" class="modal">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <h3>ðŸ“¢ Social Network</h3>
            <div id="socialPostsContainer"></div>
            <div style="margin-top: 15px; text-align: right;">
                <button type="button" onclick="modalUtils.closeModal('socialFeedModal')">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<!-- ================== MODALI PRENOTAZIONE VISITE ================== -->
<div th:fragment="prenotazione-visita-modals(redirectPath)">
    <!-- Modale input numero persone -->
    <div id="prenotazioneVisitaModal" class="modal">
        <div class="modal-content">
            <h3>Prenota Visita</h3>
            <form id="prenotazioneVisitaForm"
                  th:action="@{/prenotazioni-visite/prenota}"
                  th:object="${prenotazioneVisitaDto}"
                  method="post"
                  novalidate>
                <!-- id visita -->
                <input type="hidden" th:field="*{idVisita}" id="idVisitaPrenotazione"/>

                <!-- numero persone -->
                <label for="numeroPersone">Numero persone:</label>
                <input type="number" id="numeroPersone" th:field="*{numeroPersone}"/>
                <span id="numeroPersoneError" class="error-message"></span> <!-- FIX -->

                <!-- errori server-side -->
                <div th:if="${#fields.hasErrors('numeroPersone')}"
                     th:errors="*{numeroPersone}"
                     class="error-message"></div>

                <div class="modal-buttons">
                    <button type="submit">Prenota visita</button>
                    <button type="button" onclick="modalUtils.closeModal('prenotazioneVisitaModal')">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modale conferma -->
    <div id="prenotazioneConfirmModal" class="modal">
        <div class="modal-content">
            <p>Vuoi confermare la prenotazione della visita?</p>
            <button type="button" id="confirmPrenotazioneBtn">SÃ¬</button>
            <button type="button" onclick="modalUtils.closeModal('prenotazioneConfirmModal')">No</button>
        </div>
    </div>

    <!-- Modale successo -->
    <div id="prenotazioneSuccessModal" class="modal">
        <div class="modal-content">
            <p>âœ… Prenotazione effettuata con successo!</p>
            <button type="button" class="redirect-btn" th:attr="data-redirect=${redirectPath}">OK</button>
        </div>
    </div>

    <!-- Modale giÃ  prenotata -->
    <div id="prenotazioneGiaEffettuataModal" class="modal">
        <div class="modal-content">
            <p>âš  Hai giÃ  prenotato questa visita.</p>
            <button type="button" class="redirect-btn" th:attr="data-redirect=${redirectPath}">OK</button>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const prenotazioneForm = document.getElementById("prenotazioneVisitaForm");

            if (prenotazioneForm) {
                prenotazioneForm.addEventListener("submit", (e) => {
                    e.preventDefault();

                    const input = document.getElementById("numeroPersone");
                    const errorSpan = document.getElementById("numeroPersoneError");
                    if (errorSpan) errorSpan.textContent = ""; // reset messaggi

                    const value = parseInt(input.value);

                    // validazione client-side
                    if (!input.value || isNaN(value) || value < 1) {
                        if (errorSpan) errorSpan.textContent = "âš  Devi inserire almeno 1 persona";
                        return; // non inviare, non aprire conferma
                    }

                    // se valido â†’ apri modale conferma
                    modalUtils.openModal("prenotazioneConfirmModal");
                });
            }

            // --- conferma invio ---
            const confirmBtn = document.getElementById("confirmPrenotazioneBtn");
            if (confirmBtn) {
                confirmBtn.addEventListener("click", async () => {
                    const formData = new FormData(prenotazioneForm);
                    const { header, token } = getCsrf();
                    const errorSpan = document.getElementById("numeroPersoneError");

                    modalUtils.closeModal("prenotazioneConfirmModal");
                    modalUtils.closeModal("prenotazioneVisitaModal");

                    try {
                        const res = await fetch(prenotazioneForm.action, {
                            method: "POST",
                            headers: { [header]: token },
                            body: formData,
                            credentials: "same-origin"
                        });

                        if (res.ok) {
                            modalUtils.openModal("prenotazioneSuccessModal");
                        } else if (res.status === 409) {
                            modalUtils.openModal("prenotazioneGiaEffettuataModal");
                        } else if (res.status === 400) {
                            // âš  errore validazione lato server
                            const msg = await res.text();
                            if (errorSpan) {
                                errorSpan.textContent = msg || "âš  Errore di validazione lato server";
                                modalUtils.openModal("prenotazioneVisitaModal");
                            } else {
                                alert(msg || "âš  Errore di validazione lato server");
                            }
                        } else {
                            alert("Errore nella prenotazione: " + (await res.text()));
                        }
                    } catch (err) {
                        alert("Errore di rete: " + err.message);
                    }
                });
            }

            // --- redirect comune ---
            document.addEventListener("click", (e) => {
                if (e.target && e.target.classList.contains("redirect-btn")) {
                    [
                        "socialSuccessModal",
                        "createSuccessModal",
                        "updateSuccessModal",
                        "createSuccessModalFiera",
                        "prenotazioneSuccessModal",
                        "prenotazioneGiaEffettuataModal"
                    ].forEach(modalId => modalUtils.closeModal(modalId));

                    const url = e.target.getAttribute("data-redirect");
                    if (url) window.location.href = url;
                }
            });
        });
    </script>


</body>
</html>
