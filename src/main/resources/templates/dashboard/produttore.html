<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <title>Dashboard Produttore</title>
    <meta charset="UTF-8"/>
    <style>
        .form-container {
            display: none;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #f9f9f9;
            max-width: 500px;
        }

        .form-container label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        .form-container input,
        .form-container textarea {
            width: 100%;
            padding: 6px;
            margin-top: 5px;
        }

        .form-container input.error,
        .form-container textarea.error {
            border: 2px solid red;
        }

        .error-message {
            color: red;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
        }

        .modal-content button {
            margin: 10px;
            padding: 8px 16px;
        }
    </style>
</head>
<body>
<h1 th:text="'Benvenuto ' + ${utente != null ? utente.nome : 'Utente'} + ', il tuo ruolo è ' + (${utente != null ? utente.ruolo : 'Produttore'}) + '.'">
    Benvenuto, il tuo ruolo è Produttore.
</h1>

<h2>Dashboard Produttore</h2>

<button type="button" onclick="toggleForm()">Crea Prodotto</button>

<div id="prodottoForm" class="form-container"
     th:style="${showForm} ? 'display:block;' : 'display:none;'">

    <h3>Nuovo Prodotto</h3>
    <form id="createProductForm"
          th:action="@{/produttore/crea}"
          th:object="${prodottoDto}"
          method="post"
          enctype="multipart/form-data">

        <!-- Nome -->
        <label for="nome">Nome prodotto:</label>
        <input type="text" th:field="*{nome}" id="nome"
               th:classappend="${#fields.hasErrors('nome')} ? 'error'"/>
        <span class="error-message" th:errors="*{nome}"></span>

        <!-- Descrizione -->
        <label for="descrizione">Descrizione:</label>
        <textarea th:field="*{descrizione}" id="descrizione"
                  th:classappend="${#fields.hasErrors('descrizione')} ? 'error'"></textarea>
        <span class="error-message" th:errors="*{descrizione}"></span>

        <!-- Quantità -->
        <label for="quantita">Quantità:</label>
        <input type="number" th:field="*{quantita}" id="quantita"
               th:classappend="${#fields.hasErrors('quantita')} ? 'error'"/>
        <span class="error-message" th:errors="*{quantita}"></span>

        <!-- Prezzo -->
        <label for="prezzo">Prezzo:</label>
        <input type="number" step="0.01" th:field="*{prezzo}" id="prezzo"
               th:classappend="${#fields.hasErrors('prezzo')} ? 'error'"/>
        <span class="error-message" th:errors="*{prezzo}"></span>

        <!-- Indirizzo -->
        <label for="indirizzo">Indirizzo:</label>
        <input type="text" th:field="*{indirizzo}" id="indirizzo"
               th:classappend="${#fields.hasErrors('indirizzo')} ? 'error'"/>
        <span class="error-message" th:errors="*{indirizzo}"></span>

        <!-- Certificati -->
        <label for="certificati">Seleziona certificati:</label>
        <input type="file" th:field="*{certificati}" id="certificati" multiple
               th:classappend="${#fields.hasErrors('certificati')} ? 'error'"/>
        <span class="error-message" th:errors="*{certificati}"></span>

        <!-- Foto -->
        <label for="foto">Seleziona foto:</label>
        <input type="file" th:field="*{foto}" id="foto" multiple
               th:classappend="${#fields.hasErrors('foto')} ? 'error'"/>
        <span class="error-message" th:errors="*{foto}"></span>

        <!-- Pulsanti -->
        <button type="button" onclick="openConfirmModal()">Invia Prodotto</button>
        <button type="button" onclick="toggleForm()">Chiudi Form</button>
    </form>
</div>

<!-- Modale conferma invio -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <p>Inviare il prodotto al Curatore per approvazione?</p>
        <button onclick="submitForm()">Sì</button>
        <button onclick="closeModal('confirmModal')">No</button>
    </div>
</div>

<!-- Modale successo -->
<div id="successModal" class="modal" th:if="${successMessage}">
    <div class="modal-content">
        <p th:text="${successMessage}">Prodotto inviato al Curatore!</p>
        <button onclick="window.location.href='/dashboard'">OK</button>
    </div>
</div>

<script>
    function toggleForm() {
        const form = document.getElementById("prodottoForm");
        form.style.display = (form.style.display === "none") ? "block" : "none";
    }

    function openConfirmModal() {
        document.getElementById("confirmModal").style.display = "flex";
    }

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }

    function submitForm() {
        closeModal("confirmModal");
        document.getElementById("createProductForm").submit();
    }

    window.addEventListener("load", () => {
        const successModal = document.getElementById("successModal");
        if (successModal) {
            successModal.style.display = "flex";
        }
    });

    // Validazione client-side in tempo reale per Produttore
    document.querySelectorAll("#createProductForm input, #createProductForm textarea").forEach(el => {
        if (el.type !== "file") {
            el.addEventListener("input", () => {
                if (el.value.trim() !== "") {
                    el.classList.remove("error");
                    const errorSpan = el.nextElementSibling;
                    if (errorSpan && errorSpan.classList.contains("error-message")) {
                        errorSpan.innerText = "";
                    }
                }
            });
        }
    });

    // Certificati
    document.getElementById("certificati").addEventListener("change", function () {
        if (this.files.length > 0) {
            this.classList.remove("error");
            this.nextElementSibling.innerText = "";
        }
    });

    // Foto
    document.getElementById("foto").addEventListener("change", function () {
        if (this.files.length > 0) {
            this.classList.remove("error");
            this.nextElementSibling.innerText = "";
        }
    });

</script>

<p><a th:href="@{/}">Torna alla Home</a></p>
</body>
</html>
