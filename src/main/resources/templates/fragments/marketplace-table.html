<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<body>
<div th:fragment="marketplace-table (prodotti, pacchetti, trasformati)">
    <div class="table-container">
        <table class="acquirente-table">
            <thead>
            <tr>
                <th>Seleziona</th>
                <th>Tipo</th>
                <th>Nome</th>
                <th>Descrizione</th>
                <th>Creato da</th>
                <th>Disponibilità</th>
                <th>Quantità</th>
                <th>Foto</th>
                <th>Certificati</th>
                <th>Prezzo (€)</th>
                <th>Prodotti inclusi</th>
                <th>Fasi di produzione</th>
                <th>Indirizzo</th>
                <th>Periodo</th>
                <th>Azione</th>
            </tr>
            </thead>
            <tbody>

            <!-- ============ PRODOTTI ============ -->
            <tr th:each="p : ${prodotti}"
                th:attr="data-id=${p.id}, data-tipo='PRODOTTO', data-disponibilita=${p.quantita}">
                <td><input type="checkbox" class="select-checkbox" th:value="${p.id}"/></td>
                <td>Prodotto</td>
                <td th:text="${p.nome}"></td>
                <td th:text="${p.descrizione.length() > 100 ? p.descrizione.substring(0,100) + '…' : p.descrizione}"></td>
                <td th:text="${p.creatoDa}"></td>
                <td th:text="${p.quantita}"></td>
                <td><input type="number" class="quantita-input" name="quantitaProdotto" min="1" max="999"/></td>
                <td>
                    <span th:if="${#strings.isEmpty(p.certificatiCsv)}">-</span>
                    <span th:if="${!#strings.isEmpty(p.certificatiCsv)}"
                          th:each="cert : ${#strings.arraySplit(p.certificatiCsv, ',')}">
                        <a th:href="@{'/file/certificati/' + ${cert}}" th:text="${cert}" target="_blank"></a><br/>
                    </span>
                </td>
                <td>
                    <span th:if="${#strings.isEmpty(p.fotoCsv)}">-</span>
                    <span th:if="${!#strings.isEmpty(p.fotoCsv)}"
                          th:each="foto : ${#strings.arraySplit(p.fotoCsv, ',')}">
                        <a th:href="@{'/file/foto/' + ${foto}}" target="_blank">
                            <img th:src="@{'/file/foto/' + ${foto}}" alt="Foto" style="max-height:40px;"/>
                        </a>
                    </span>
                </td>

                <td th:text="${p.prezzo}"></td>
                <td></td>
                <td></td>
                <td th:text="${p.indirizzo}"></td>
                <td></td>
                <td class="action-cell"></td>
            </tr>

            <!-- ============ PACCHETTI ============ -->
            <tr th:each="pac : ${pacchetti}"
                th:attr="data-id=${pac.id}, data-tipo='PACCHETTO', data-disponibilita=${pac.quantita}">
                <td><input type="checkbox" class="select-checkbox" th:value="${pac.id}"/></td>
                <td>Pacchetto</td>
                <td th:text="${pac.nome}"></td>
                <td th:text="${pac.descrizione.length() > 100 ? pac.descrizione.substring(0,100) + '…' : pac.descrizione}"></td>
                <td th:text="${pac.creatoDa}"></td>
                <td th:text="${pac.quantita}"></td>
                <td><input type="number" class="quantita-input" name="quantitaPacchetto" min="1" max="999"/></td>

                <!-- FOTO -->
                <td>
                    <span th:if="${#strings.isEmpty(pac.fotoCsv)}">-</span>
                    <span th:if="${!#strings.isEmpty(pac.fotoCsv)}"
                          th:each="foto : ${#strings.arraySplit(pac.fotoCsv, ',')}">
            <a th:href="@{'/file/foto/' + ${foto}}" target="_blank">
                <img th:src="@{'/file/foto/' + ${foto}}" alt="Foto" style="max-height:40px;"/>
            </a>
        </span>
                </td>

                <!-- CERTIFICATI -->
                <td>
                    <span th:if="${#strings.isEmpty(pac.certificatiCsv)}">-</span>
                    <span th:if="${!#strings.isEmpty(pac.certificatiCsv)}"
                          th:each="cert : ${#strings.arraySplit(pac.certificatiCsv, ',')}">
            <a th:href="@{'/file/certificati/' + ${cert}}" th:text="${cert}" target="_blank"></a><br/>
        </span>
                </td>

                <td th:text="${pac.prezzo}"></td>
                <td>
        <span th:each="nome, iter : ${pac.prodottiNomi}">
            <span th:text="${nome}"></span>
            <span th:if="${!iter.last}"> · </span>
        </span>
                </td>
                <td></td>
                <td th:text="${pac.indirizzo}"></td>
                <td></td>
                <td class="action-cell"></td>
            </tr>

            <!-- ============ PRODOTTI TRASFORMATI ============ -->
            <tr th:each="t : ${trasformati}"
                th:attr="data-id=${t.id}, data-tipo='TRASFORMATO', data-disponibilita=${t.quantita}">
                <td><input type="checkbox" class="select-checkbox" th:value="${t.id}"/></td>
                <td>Prodotto trasformato</td>
                <td th:text="${t.nome}"></td>
                <td th:text="${t.descrizione.length() > 100 ? t.descrizione.substring(0,100) + '…' : t.descrizione}"></td>
                <td th:text="${t.creatoDa}"></td>
                <td th:text="${t.quantita}"></td>
                <td><input type="number" class="quantita-input" name="quantitaTrasformato" min="1" max="999"/></td>

                <!-- FOTO -->
                <td>
                    <span th:if="${#strings.isEmpty(t.fotoCsv)}">-</span>
                    <span th:if="${!#strings.isEmpty(t.fotoCsv)}"
                          th:each="foto : ${#strings.arraySplit(t.fotoCsv, ',')}">
            <a th:href="@{'/file/foto/' + ${foto}}" target="_blank">
                <img th:src="@{'/file/foto/' + ${foto}}" alt="Foto" style="max-height:40px;"/>
            </a>
        </span>
                </td>

                <!-- CERTIFICATI -->
                <td>
                    <span th:if="${#strings.isEmpty(t.certificatiCsv)}">-</span>
                    <span th:if="${!#strings.isEmpty(t.certificatiCsv)}"
                          th:each="cert : ${#strings.arraySplit(t.certificatiCsv, ',')}">
            <a th:href="@{'/file/certificati/' + ${cert}}" th:text="${cert}" target="_blank"></a><br/>
        </span>
                </td>

                <td th:text="${t.prezzo}"></td>
                <td></td>
                <td>
        <span th:each="fase, iter : ${t.fasiProduzione}">
            <span th:text="${fase.descrizioneFase} + ' (prod: ' + ${fase.produttoreUsername} + ')'"></span>
            <span th:if="${!iter.last}"> · </span>
        </span>
                </td>
                <td th:text="${t.indirizzo}"></td>
                <td></td>
                <td class="action-cell"></td>
            </tr>


            </tbody>
        </table>
    </div>
</div>
</body>
</html>
