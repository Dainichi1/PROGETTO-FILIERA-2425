<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <title>Dashboard Distributore</title>
    <meta charset="UTF-8"/>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
</head>
<body>
<h1 th:text="'Benvenuto ' + (${utente?.nome ?: 'Utente'}) +
              ', il tuo ruolo Ã¨ ' + (${utente?.ruolo ?: 'Distributore'}) + '.'">
    Benvenuto, il tuo ruolo Ã¨ Distributore.
</h1>

<h2>I tuoi Prodotti</h2>
<button type="button" onclick="crudUtils.openSocialFeed()">ðŸ“¢ Visualizza Social Network</button>
<button type="button" onclick="toggleVisite()">ðŸ‘€ Visualizza visite disponibili</button>

<h2>I tuoi Pacchetti</h2>

<!-- Tabella pacchetti -->
<div th:replace="fragments/table :: dashboard-table(${pacchetti}, 'pacchetto')"></div>

<!-- Tabella visite disponibili (nascosta di default) -->
<div id="visiteSection" style="display:none; margin-top: 20px;">
    <div th:replace="fragments/visite-table :: visite-table(${visiteDisponibili})"></div>
    <div style="margin-top: 10px;">
        <button type="button" onclick="toggleVisite()">Chiudi</button>
    </div>
</div>

<!-- ================= MODALI COMUNI ================= -->
<div th:replace="fragments/modals :: delete-modals('pacchetti')"></div>
<div th:replace="fragments/modals :: edit-error-modal('pacchetti')"></div>
<div th:replace="fragments/modals :: social-modal"></div> <!-- avviso social -->
<div th:replace="fragments/modals :: social-feed-modal"></div>
<div th:replace="fragments/modals :: social-post-modals('/distributore/dashboard')"></div>

<!-- ================= MODALI PRENOTAZIONE VISITE ================= -->
<div th:replace="fragments/modals :: prenotazione-visita-modals('/distributore/dashboard')"></div>

<hr class="section-separator"/>

<button type="button" onclick="crudUtils.toggleForm()">Crea Pacchetto</button>

<!-- Form creazione/modifica -->
<div id="pacchettoForm" class="form-container"
     th:style="${showForm} ? 'display:block;' : 'display:none;'">
    <h3 id="formTitle">Nuovo Pacchetto</h3>
    <form id="packageForm" th:action="@{/distributore/crea}" th:object="${pacchettoDto}"
          method="post" enctype="multipart/form-data" novalidate>

        <input type="hidden" th:field="*{id}" id="itemId"/>
        <input type="hidden" th:field="*{tipo}" id="itemTipo" value="PACCHETTO"/>

        <!-- Campi standard -->
        <div th:replace="fragments/form-fields :: base-fields('pacchettoDto')"></div>

        <!-- Campo specifico Pacchetto -->
        <label>Seleziona Prodotti Approvati (minimo 2):</label>
        <div class="checkbox-list"
             th:classappend="${#fields.hasErrors('prodottiSelezionati')} ? 'error'">
            <div th:each="prodotto : ${prodottiApprovati}">
                <label>
                    <input type="checkbox" th:field="*{prodottiSelezionati}" th:value="${prodotto.id}"/>
                    <span th:text="${prodotto.nome}">Nome prodotto</span>
                </label>
            </div>
        </div>
        <span class="error-message"
              th:utext="${#fields.hasErrors('prodottiSelezionati')} ?
                        ${#strings.arrayJoin(#fields.errors('prodottiSelezionati'), '<br/>')} : ''">
        </span>

        <!-- Pulsanti -->
        <div th:replace="fragments/form-fields :: form-buttons('pacchetto','/distributore/dashboard')"></div>
    </form>
</div>

<p><a th:href="@{/}">Torna alla Home</a></p>

<!-- ================= SCRIPT ================= -->
<script src="/js/utils/form-utils.js" defer></script>
<script src="/js/utils/modal-utils.js" defer></script>
<script src="/js/utils/csrf-utils.js" defer></script>
<script src="/js/utils/crud-utils.js" defer></script>
<script src="/js/pages/distributore.js" defer></script>

<!-- Script per toggle visite -->
<script>
    function toggleVisite() {
        const section = document.getElementById("visiteSection");
        section.style.display = section.style.display === "none" ? "block" : "none";
    }
</script>
</body>
</html>
